{% extends 'base_store.html' %}
{% load static %}

{% block title %}Store Dashboard{% endblock %}

{% block content %}
<div class="container mx-auto p-6">
  <h1 class="text-3xl font-bold mb-8">📊 Store Insights Dashboard</h1>

  <!-- ✅ KPI SUMMARY -->
  <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-6 mb-8">
    <div class="bg-white rounded-xl shadow-sm p-5 border border-gray-100 hover:shadow-md transition">
      <p class="text-gray-500 text-sm">Total Orders</p>
      <h2 class="text-2xl font-bold text-blue-600">{{ total_orders|default:0 }}</h2>
    </div>
    <div class="bg-white rounded-xl shadow-sm p-5 border border-gray-100 hover:shadow-md transition">
      <p class="text-gray-500 text-sm">Completed</p>
      <h2 class="text-2xl font-bold text-green-600">{{ completed_orders|default:0 }}</h2>
    </div>
    <div class="bg-white rounded-xl shadow-sm p-5 border border-gray-100 hover:shadow-md transition">
      <p class="text-gray-500 text-sm">Pending</p>
      <h2 class="text-2xl font-bold text-yellow-600">{{ pending_orders|default:0 }}</h2>
    </div>
    <div class="bg-white rounded-xl shadow-sm p-5 border border-gray-100 hover:shadow-md transition">
      <p class="text-gray-500 text-sm">Total Revenue</p>
      <h2 class="text-2xl font-bold text-purple-600">₹{{ total_amount|default:"0.00" }}</h2>
    </div>
  </div>

  <!-- ✅ CHARTS -->
  <div class="grid md:grid-cols-2 gap-6 mb-8">
    <!-- Orders by Status -->
    <div class="bg-white p-6 rounded-xl shadow-sm border border-gray-100">
      <h2 class="text-lg font-semibold mb-3 flex items-center gap-2">📈 Orders by Status</h2>
      <canvas id="statusChart" height="140"></canvas>
    </div>

    <!-- Daily Orders Trend -->
    <div class="bg-white p-6 rounded-xl shadow-sm border border-gray-100">
      <h2 class="text-lg font-semibold mb-3">📆 Daily Orders Trend</h2>
      <canvas id="dailyChart" height="140"></canvas>
    </div>
  </div>

  <!-- ✅ INSIGHTS -->
  <div class="grid md:grid-cols-2 gap-6">
    <!-- Category Insights -->
    <div class="bg-white p-6 rounded-xl shadow-sm border border-gray-100">
      <h2 class="text-lg font-semibold mb-3">📦 Category Insights</h2>
      {% if category_data %}
      <ul class="divide-y divide-gray-100">
        {% for category in category_data %}
        <li class="flex justify-between py-2">
          <span class="text-gray-700">{{ category.asset__category__name|default:"Uncategorized" }}</span>
          <span class="font-medium text-gray-900">
            {{ category.item_count }} {{ category.item_count|pluralize:"Item,Items" }}
          </span>
        </li>
        {% endfor %}
      </ul>
      {% else %}
      <p class="text-gray-500 italic text-sm">No category data available.</p>
      {% endif %}
    </div>

    <!-- Top Ordered Assets -->
    <div class="bg-white p-6 rounded-xl shadow-sm border border-gray-100">
      <h2 class="text-lg font-semibold mb-3">🏅 Top Ordered Assets</h2>
      {% if top_assets %}
      <ul class="divide-y divide-gray-100">
        {% for asset in top_assets %}
        <li class="flex justify-between py-2">
          <span class="text-gray-700">{{ asset.asset__name|default:"Unnamed Asset" }}</span>
          <span class="font-medium text-gray-900">
            {{ asset.total_orders }} {{ asset.total_orders|pluralize:"Order,Orders" }}
          </span>
        </li>
        {% endfor %}
      </ul>
      {% else %}
      <p class="text-gray-500 italic text-sm">No asset data available yet.</p>
      {% endif %}
    </div>
  </div>

  <!-- ✅ RECENT ORDERS -->
  <div class="bg-white mt-8 p-6 rounded-xl shadow-sm border border-gray-100">
    <h2 class="text-lg font-semibold mb-4">🧾 Recent Orders</h2>
    {% if orders %}
    <div class="overflow-x-auto">
      <table class="min-w-full border border-gray-100 rounded-lg text-sm">
        <thead class="bg-gray-50 text-gray-600">
          <tr>
            <th class="py-2 px-4 text-left">Order ID</th>
            <th class="py-2 px-4 text-left">DC No</th>
            <th class="py-2 px-4 text-left">Items</th>
            <th class="py-2 px-4 text-left">Amount</th>
            <th class="py-2 px-4 text-left">Status</th>
            <th class="py-2 px-4 text-left">Date</th>
          </tr>
        </thead>
        <tbody>
          {% for order in orders %}
          <tr class="border-t hover:bg-gray-50">
            <td class="py-2 px-4">{{ order.order_id }}</td>
            <td class="py-2 px-4">{{ order.dc_number }}</td>
            <td class="py-2 px-4">{{ order.total_items }}</td>
            <td class="py-2 px-4">₹{{ order.amount|default:"0.00" }}</td>
            <td class="py-2 px-4">
              <span class="px-2 py-1 rounded text-xs 
                {% if order.status == 'Completed' %}
                  bg-green-100 text-green-700
                {% elif order.status == 'Pending' %}
                  bg-yellow-100 text-yellow-700
                {% else %}
                  bg-gray-100 text-gray-700
                {% endif %}">
                {{ order.status }}
              </span>
            </td>
            <td class="py-2 px-4">{{ order.created_at|date:"d M Y" }}</td>
          </tr>
          {% endfor %}
        </tbody>
      </table>
    </div>
    {% else %}
    <p class="text-gray-500 text-sm">No orders yet.</p>
    {% endif %}
  </div>
</div>

<!-- ✅ Tailwind + Chart.js -->
<script src="https://cdn.tailwindcss.com"></script>
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>

<script>
document.addEventListener("DOMContentLoaded", () => {
  // ✅ Orders by Status
  const statusCtx = document.getElementById('statusChart');
  new Chart(statusCtx, {
    type: 'doughnut',
    data: {
      labels: ['Completed', 'Pending'],
      datasets: [{
        data: [{{ completed_orders|default:0 }}, {{ pending_orders|default:0 }}],
        backgroundColor: ['#22c55e', '#facc15'],
        borderWidth: 0
      }]
    },
    options: {
      plugins: { legend: { position: 'bottom' } },
      cutout: '70%'
    }
  });

  // ✅ Daily Orders Trend
  const dailyOrders = JSON.parse('{{ daily_orders_json|default:"[]"|escapejs }}');
  if (dailyOrders.length > 0) {
    new Chart(document.getElementById('dailyChart'), {
      type: 'line',
      data: {
        labels: dailyOrders.map(d => d.date),
        datasets: [{
          label: 'Orders per Day',
          data: dailyOrders.map(d => d.count),
          fill: true,
          borderColor: '#3b82f6',
          backgroundColor: 'rgba(59,130,246,0.15)',
          tension: 0.3
        }]
      },
      options: {
        plugins: { legend: { display: false } },
        scales: { y: { beginAtZero: true } }
      }
    });
  }
});
</script>
{% endblock %}
