{% extends 'base.html' %}
{% block title %}My Orders ‚Äî Skyplay{% endblock %}
{% block content %}

<style>
@keyframes fadeInUp { from {opacity:0;transform:translateY(30px);} to {opacity:1;transform:translateY(0);} }
@keyframes popIn { from {opacity:0;transform:scale(0.9);} to {opacity:1;transform:scale(1);} }
.fade-in-up { animation: fadeInUp 0.6s ease-out; }
.pop-in { animation: popIn 0.4s ease-in-out; }

.order-card { transition: all 0.3s ease; }
.order-card:hover { transform: translateY(-5px); box-shadow: 0 10px 25px rgba(0,0,0,0.1); }

.icon-btn { display:inline-flex;align-items:center;justify-content:center;width:40px;height:40px;
  border-radius:9999px;transition:all 0.3s ease;position:relative;cursor:pointer; }
.icon-btn svg { width:22px;height:22px; }

.btn-track { background:linear-gradient(135deg,#3b82f6,#60a5fa);color:white; }
.btn-track:hover { transform:scale(1.1);box-shadow:0 0 12px rgba(59,130,246,0.5); }

.btn-received { background:linear-gradient(135deg,#22c55e,#4ade80);color:white; }
.btn-received:hover { transform:scale(1.1);box-shadow:0 0 12px rgba(34,197,94,0.5); }

.icon-btn::after { content:attr(data-tooltip);position:absolute;bottom:120%;background:rgba(0,0,0,0.75);
  color:white;font-size:12px;padding:4px 8px;border-radius:6px;opacity:0;transform:translateY(5px);
  pointer-events:none;transition:all 0.2s ease;white-space:nowrap; }
.icon-btn:hover::after { opacity:1;transform:translateY(0); }

.message-box { 
  display:none; position:fixed; bottom:30px; right:30px; 
  background:rgba(0,0,0,0.85); color:white; padding:12px 18px; 
  border-radius:10px; font-size:14px; animation:fadeInUp 0.5s ease;
  box-shadow:0 6px 20px rgba(0,0,0,0.2);
}
</style>

<div class="container mx-auto px-4 sm:px-6 lg:px-8 py-10 fade-in-up">
  <div class="flex items-center justify-between mb-8">
    <h1 class="text-3xl font-bold text-gray-800 flex items-center gap-3">
      <svg xmlns="http://www.w3.org/2000/svg" class="w-8 h-8 text-red-600" fill="none" viewBox="0 0 24 24" stroke="currentColor">
        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
              d="M3 3h2l.4 2M7 13h10l4-8H5.4M7 13l-1.5 7h13L17 13M9 21a1 1 0 100-2 1 1 0 000 2zm8 0a1 1 0 100-2 1 1 0 000 2z" />
      </svg>
      My Orders
    </h1>
  </div>

  {% if orders %}
  <ul class="grid gap-6 sm:grid-cols-2 lg:grid-cols-3">
    {% for order in orders %}
    <li class="order-card bg-white rounded-2xl shadow-md border border-gray-100 p-6 flex flex-col justify-between pop-in">
      <div>
        <div class="flex items-center justify-between">
          <h2 class="text-lg font-semibold text-gray-800">Order #{{ order.order_id }}</h2>
          <span class="px-3 py-1 text-sm font-medium rounded-full
            {% if order.status == 'Delivered' %} bg-green-100 text-green-700
            {% elif order.status == 'Pending' %} bg-yellow-100 text-yellow-700
            {% elif order.status == 'Paid' %} bg-blue-100 text-blue-700
            {% else %} bg-gray-100 text-gray-700 {% endif %}">
            {{ order.status }}
          </span>
        </div>
        <p class="text-sm text-gray-500 mt-1">Placed on {{ order.created_at|date:"d M Y, H:i" }}</p>
      </div>

      <div class="mt-6 flex items-center justify-between">
        <div class="flex items-center gap-2">
          <svg xmlns="http://www.w3.org/2000/svg" class="w-5 h-5 text-gray-600" fill="none" viewBox="0 0 24 24" stroke="currentColor">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5"
                  d="M12 8c1.657 0 3-.895 3-2s-1.343-2-3-2-3 .895-3 2 1.343 2 3 2zm0 2a9 9 0 00-9 9v1h18v-1a9 9 0 00-9-9z" />
          </svg>
          <span class="text-lg font-semibold text-gray-800">‚Çπ{{ order.amount|floatformat:2 }}</span>
        </div>

        <div class="flex items-center gap-3">
          <!-- View Order -->
          <a href="{% url 'order_detail' order.pk %}"
             class="inline-flex items-center px-3 py-2 text-sm font-medium text-white bg-red-600 rounded-lg hover:bg-red-700 transition-all duration-200">
            <svg xmlns="http://www.w3.org/2000/svg" class="w-5 h-5 mr-1" fill="none" viewBox="0 0 24 24" stroke="currentColor">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.8" d="M15 12H9m12 0a9 9 0 11-18 0 9 9 0 0118 0z" />
            </svg>
            View
          </a>

          <!-- Track Shipping -->
          <button class="icon-btn btn-track" data-tooltip="Track Shipping" onclick="showMessage('üöö Tracking feature coming soon!')">
            <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.8"
                    d="M3 3h13v6h5l-1.5 6H16m-9 5a2 2 0 110-4 2 2 0 010 4zm10 0a2 2 0 110-4 2 2 0 010 4z" />
            </svg>
          </button>

          <!-- Item Received -->
          <button class="icon-btn btn-received" data-tooltip="Item Received"
                  onclick="openReceivedModal('{{ order.id }}', '{{ order.order_id }}')">
            <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.8"
                    d="M5 13l4 4L19 7" />
            </svg>
          </button>
        </div>
      </div>
    </li>
    {% endfor %}
  </ul>

  {% else %}
  <div class="flex flex-col items-center justify-center mt-16 text-center fade-in-up">
    <svg xmlns="http://www.w3.org/2000/svg" class="w-20 h-20 text-gray-400 mb-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M3 3h18M9 3v18m6-18v18M3 9h18M3 15h18" />
    </svg>
    <p class="text-gray-500 text-lg">You have no orders yet.</p>
    <a href="{% url 'home' %}" class="mt-4 inline-flex items-center px-5 py-2 bg-red-600 text-white rounded-lg hover:bg-red-700 transition">
      Start Shopping
    </a>
  </div>
  {% endif %}
</div>

<!-- ‚úÖ Single Modal placed OUTSIDE loop -->
<div id="receivedModal" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
  <div class="bg-white rounded-2xl p-6 shadow-lg w-96 relative">
    <h2 class="text-lg font-semibold mb-2">Confirm Item Received</h2>
    <p id="modalOrderInfo" class="text-gray-600 mb-4"></p>

    <div class="flex justify-end space-x-3">
      <button onclick="closeReceivedModal()" class="px-4 py-2 bg-gray-200 rounded-lg hover:bg-gray-300">Cancel</button>
      <button id="confirmReceivedBtn" class="px-4 py-2 bg-green-600 text-white rounded-lg hover:bg-green-700">
        Confirm
      </button>
    </div>

    <button onclick="closeReceivedModal()" class="absolute top-2 right-3 text-gray-500 hover:text-gray-700">‚úï</button>
  </div>
</div>

<!-- floating message -->
<div id="messageBox" class="message-box"></div>

<script>
let currentOrderId = null;

// üü¢ Open modal only once
function openReceivedModal(orderId, orderCode) {
  currentOrderId = orderId;
  document.getElementById('modalOrderInfo').textContent =
    `Are you sure you have received the items for Order #${orderCode}?`;
  document.getElementById('receivedModal').classList.remove('hidden');
}

// üî¥ Close modal
function closeReceivedModal() {
  document.getElementById('receivedModal').classList.add('hidden');
}

// ‚úÖ Floating Message
function showMessage(text) {
  const box = document.getElementById("messageBox");
  box.innerText = text;
  box.style.display = "block";
  setTimeout(() => { box.style.display = "none"; }, 3000);
}

// ‚úÖ Confirm Received
document.getElementById('confirmReceivedBtn').addEventListener('click', async () => {
  const csrfToken = document.querySelector('[name=csrfmiddlewaretoken]').value;
  const response = await fetch(`/order/mark-received/${currentOrderId}/`, {
    method: 'POST',
    headers: { 'Content-Type': 'application/json', 'X-CSRFToken': csrfToken },
    body: JSON.stringify({ received: true }),
  });
  const data = await response.json();
  if (data.success) {
    closeReceivedModal();
    showMessage(data.message || '‚úÖ Order marked as received!');
    setTimeout(() => location.reload(), 2000);
  } else {
    showMessage(data.message || '‚ùå Something went wrong');
  }
});
</script>

{% endblock %}
