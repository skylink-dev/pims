{% extends 'base.html' %}
{% load static %}

{% block title %}Customer Asset Mapping{% endblock %}

{% block content %}
<div class="container mx-auto p-6">
  <h2 class="text-3xl font-bold mb-6 text-red-700">Customer Asset Mapping</h2>

  <!-- Modal -->
  <div
    id="mapModal"
    class="hidden fixed inset-0 z-50 flex items-center justify-center bg-black bg-opacity-50"
  >
    <div class="bg-white rounded-lg p-6 w-full max-w-md shadow-lg">
      <h3 class="text-xl font-semibold mb-3">Map Asset to Customer</h3>

      <!-- Search Section -->
      <div class="mb-4 flex items-center space-x-2">
        <input
          id="searchPhone"
          class="border p-2 rounded w-full"
          placeholder="Enter customer phone"
        />
        <button id="btnSearch" class="bg-red-600 text-white px-3 py-2 rounded">
          Search
        </button>
      </div>
      <div id="searchStatus" class="mb-3 text-sm text-gray-600"></div>

      <!-- Customer Info -->
      <div id="customerCard" class="hidden bg-gray-50 p-3 rounded mb-4 border">
        <p><strong>Name:</strong> <span id="cust_name"></span></p>
        <p><strong>Phone:</strong> <span id="cust_phone"></span></p>
        <p><strong>Email:</strong> <span id="cust_email"></span></p>
        <p><strong>Address:</strong> <span id="cust_address"></span></p>
      </div>

      <!-- Buttons -->
      <div class="flex justify-end space-x-2">
        <button id="cancelMap" class="px-3 py-2 rounded bg-gray-300">
          Cancel
        </button>
        <button
          id="confirmMap"
          class="px-3 py-2 rounded bg-green-600 text-white hidden"
        >
          Assign
        </button>
      </div>
    </div>
  </div>

  <!-- Asset Table -->
  <form method="post">
    {% csrf_token %}
    <table class="min-w-full bg-white border rounded shadow-sm">
     <thead class="bg-gray-100">
            <tr>
                <th class="p-2 border">Order ID</th>
                <th class="p-2 border">Asset Name</th>
                <th class="p-2 border">Serial</th>
                <th class="p-2 border">Mapped To</th>
                <th class="p-2 border">Sky ID</th>
                <th class="p-2 border">Payment Status</th>
                <th class="p-2 border">Mapped Date</th>
                <th class="p-2 border">Assigned By</th>
                <th class="p-2 border">Action</th>
            </tr>
        </thead>

        <tbody>
            {% for s in serials %}
            {% with mapping=s.customerassetmapping_set.first %}
            <tr class="border-b hover:bg-gray-50">
                <!-- Order ID -->
                <td class="p-2">
                {{ s.order_item.order.order_id }}
                </td>

                <!-- Asset Name -->
                <td class="p-2">
                {{ s.order_item.asset.name }}
                </td>

                <!-- Serial Number -->
                <td class="p-2">
                {{ s.serial_number }}
                </td>

                <!-- Customer Info -->
                <td class="p-2">
                {% if mapping %}
                    {{ mapping.customer_name }} ({{ mapping.phone }})
                {% else %}
                    —
                {% endif %}
                </td>

                <!-- Sky ID -->
                <td class="p-2">
                {% if mapping.skyid %}
                    {{ mapping.skyid }}
                {% else %}
                    —
                {% endif %}
                </td>

                <!-- Payment Status -->
                <td class="p-2">
                {% if s.order_item.order.payment_status %}
                    {{ s.order_item.order.payment_status }}
                {% else %}
                    Paid
                {% endif %}
                </td>

                <!-- Mapped Date -->
                <td class="p-2">
                {% if mapping %}
                    {{ mapping.assigned_at|date:"d-M-Y h:i A" }}
                {% else %}
                    —
                {% endif %}
                </td>

                <!-- Assigned By -->
                <td class="p-2">
                {% if mapping.assigned_by %}
                    {{ mapping.assigned_by.username }}
                {% else %}
                    —
                {% endif %}
                </td>

                <!-- Action -->
                <td class="p-2 text-center">
                {% if mapping %}
                    <button class="px-3 py-1 rounded bg-gray-400 text-white" disabled>
                    Mapped
                    </button>
                {% else %}
                    <button
                    type="button"
                    class="px-3 py-1 rounded bg-green-600 text-white open-map-modal"
                    data-serial="{{ s.id }}"
                    >
                    Map Customer
                    </button>
                {% endif %}
                </td>
            </tr>
            {% endwith %}
            {% empty %}
            <tr>
                <td colspan="9" class="text-center p-4 text-gray-500">
                No assets available for mapping.
                </td>
            </tr>
            {% endfor %}
            </tbody>

        </table>
  </form>
</div>
{% endblock %}

{% block extra_js %}
  <script src="{% static 'js/customer_mapping.js' %}"></script>
{% endblock %}
