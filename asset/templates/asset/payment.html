{% extends "base.html" %}
{% block content %}
<style>
@keyframes fadeInUp {
  from { opacity: 0; transform: translateY(30px); }
  to { opacity: 1; transform: translateY(0); }
}
.fade-in-up {
  animation: fadeInUp 0.8s ease-in-out;
}
.spinner {
  border: 4px solid rgba(255, 255, 255, 0.3);
  border-top: 4px solid white;
  border-radius: 50%;
  width: 30px;
  height: 30px;
  animation: spin 1s linear infinite;
}
@keyframes spin { to { transform: rotate(360deg); } }
</style>

<div class="flex flex-col items-center justify-center min-h-[80vh] text-center fade-in-up px-4">
  <div class="bg-white shadow-lg rounded-2xl p-8 max-w-md w-full">
    <h2 class="text-2xl font-semibold text-gray-800 mb-2">Proceed to Payment</h2>
    <p class="text-gray-600 mb-4">Order ID: <strong>{{ order.order_id }}</strong></p>
    <p class="text-lg font-medium mb-6">Amount: <span class="text-green-600 font-bold">â‚¹{{ order.display_amount  }}</span></p>

    <div class="mb-4">
      <label class="block text-gray-700 font-medium mb-1">Choose Payment Gateway</label>
      <select id="gateway" class="w-full border rounded-lg p-2 focus:ring focus:ring-blue-200">
        <option value="razorpay" selected>Razorpay</option>
      </select>
    </div>

    <div id="loading" class="flex flex-col items-center hidden">
      <div class="spinner mb-2"></div>
      <p class="text-gray-500 text-sm">Redirecting to secure payment...</p>
    </div>

    <button id="rzp-button1" class="bg-blue-600 text-white px-5 py-2 rounded-lg shadow hover:bg-blue-700 transition mt-3">
      Pay with Razorpay
    </button>

    <p class="text-xs text-gray-400 mt-4">Your payment is 100% secure & encrypted ðŸ”’</p>
  </div>
</div>

<script src="https://checkout.razorpay.com/v1/checkout.js"></script>
<script>
document.addEventListener("DOMContentLoaded", function() {
  const loading = document.getElementById("loading");
  const payBtn = document.getElementById("rzp-button1");

  var options = {
      "key": "{{ razorpay_key }}",
      "amount": "{{ amount }}",
      "currency": "INR",
      "name": "Skylink PIMS",
      "description": "Order #{{ order.order_id }}",
      "order_id": "{{ order.order_id }}",

      // âœ… Auto-prefill user info
      "prefill": {
          "name": "{{ request.user.get_full_name|default:request.user.username }}",
          "email": "{{ request.user.email }}",
          "contact": "{{ partner.phone|default:'' }}"
      },

     "handler": function (response){
    // Send payment details to Django for verification
    fetch("{% url 'success_page' %}", {
        method: "POST",
        headers: {
            "Content-Type": "application/x-www-form-urlencoded",
            "X-CSRFToken": "{{ csrf_token }}"
        },
        body: new URLSearchParams({
            razorpay_payment_id: response.razorpay_payment_id,
            razorpay_order_id: response.razorpay_order_id,
            razorpay_signature: response.razorpay_signature
        })
    })
    .then(res => res.text())
    .then(html => {
        document.body.innerHTML = html;  // directly load success page popup
    });
},
      "theme": {
          "color": "#2563eb"
      }
  };

  var rzp1 = new Razorpay(options);

  // Auto open Razorpay after animation
  setTimeout(() => {
    loading.classList.remove("hidden");
    payBtn.classList.add("hidden");
    rzp1.open();
  }, 1000);

  payBtn.onclick = function(e){
      rzp1.open();
      e.preventDefault();
  }
});
</script>
{% endblock %}
